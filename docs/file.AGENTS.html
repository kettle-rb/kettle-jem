<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: AGENTS
  
    &mdash; Documentation by YARD 0.9.38
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" />

  <link rel="stylesheet" href="css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "AGENTS";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="file_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: AGENTS</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><div id='filecontents'><h1 id="agentsmd---kettle-jem-development-guide">AGENTS.md - kettle-jem Development Guide</h1>

<h2 id="-project-overview">ğŸ¯ Project Overview</h2>

<p><code>kettle-jem</code> is a <strong>collection of <code>Ast::Merge::MergerConfig</code> presets and utilities for gem templating</strong>. It provides pre-configured merge settings (signature generators, node typing, section classifiers) for common file types used in gem development â€” Ruby files (Gemfile, Appraisals, gemspec), Markdown (README, CHANGELOG), YAML, JSON, RBS, and Dotenv files.</p>

<p><strong>Core Philosophy</strong>: Extract reusable merge configuration from <code>kettle-dev</code> into declarative presets and YAML recipes, so gem templating logic is composable and testable.</p>

<p><strong>Repository</strong>: https://github.com/kettle-rb/kettle-jem<br>
<strong>Current Version</strong>: 1.0.0<br>
<strong>Required Ruby</strong>: &gt;= 3.2.0 (currently developed against Ruby 4.0.1)</p>

<h2 id="ï¸-ai-agent-terminal-limitations">âš ï¸ AI Agent Terminal Limitations</h2>

<h3 id="terminal-output-is-not-visible">Terminal Output Is Not Visible</h3>

<p><strong>CRITICAL</strong>: AI agents using <code>run_in_terminal</code> almost never see the command output. The terminal tool sends commands to a persistent Copilot terminal, but output is frequently lost or invisible to the agent.</p>

<p><strong>Workaround</strong>: Always redirect output to a file in the projectâ€™s local <code>tmp/</code> directory, then read it back:</p>

<pre class="code language-bash"><code class="language-bash">bundle exec rspec spec/some_spec.rb &gt; tmp/test_output.txt 2&gt;&amp;1
</code></pre>
<p>Then use <code>read_file</code> to see <code>tmp/test_output.txt</code>.</p>

<p><strong>NEVER</strong> use <code>/tmp</code> or other system directories â€” always use the projectâ€™s own <code>tmp/</code> directory.</p>

<h3 id="direnv-requires-separate-cd-command">direnv Requires Separate <code>cd</code> Command</h3>

<p><strong>CRITICAL</strong>: The project uses <code>direnv</code> to load environment variables from <code>.envrc</code>. When you <code>cd</code> into the project directory, <code>direnv</code> initializes <strong>after</strong> the shell prompt returns. If you chain <code>cd</code> with other commands via <code>&amp;&amp;</code>, the subsequent commands run <strong>before</strong> <code>direnv</code> has loaded the environment.</p>

<p>âœ… <strong>CORRECT</strong> â€” Run <code>cd</code> alone, then run commands separately:</p>
<pre class="code language-bash"><code class="language-bash">cd /home/pboling/src/kettle-rb/ast-merge/vendor/kettle-jem
</code></pre>
<pre class="code language-bash"><code class="language-bash">bundle exec rspec
</code></pre>

<p>âŒ <strong>WRONG</strong> â€” Never chain <code>cd</code> with <code>&amp;&amp;</code>:</p>
<pre class="code language-bash"><code class="language-bash">cd /home/pboling/src/kettle-rb/ast-merge/vendor/kettle-jem &amp;&amp; bundle exec rspec
</code></pre>

<h3 id="prefer-internal-tools-over-terminal">Prefer Internal Tools Over Terminal</h3>

<p>âœ… <strong>PREFERRED</strong> â€” Use internal tools:</p>
<ul>
  <li>
<code>grep_search</code> instead of <code>grep</code> command</li>
  <li>
<code>file_search</code> instead of <code>find</code> command</li>
  <li>
<code>read_file</code> instead of <code>cat</code> command</li>
  <li>
<code>list_dir</code> instead of <code>ls</code> command</li>
  <li>
<code>replace_string_in_file</code> or <code>create_file</code> instead of <code>sed</code> / manual editing</li>
</ul>

<p>âŒ <strong>AVOID</strong> when possible:</p>
<ul>
  <li>
<code>run_in_terminal</code> for information gathering</li>
</ul>

<p>Only use terminal for:</p>
<ul>
  <li>Running tests (<code>bundle exec rspec</code>)</li>
  <li>Installing dependencies (<code>bundle install</code>)</li>
  <li>Git operations that require interaction</li>
  <li>Commands that actually need to execute (not just gather info)</li>
</ul>

<h3 id="never-pipe-test-commands-through-headtail">NEVER Pipe Test Commands Through head/tail</h3>

<p>âŒ <strong>ABSOLUTELY FORBIDDEN</strong>:</p>
<pre class="code language-bash"><code class="language-bash">bundle exec rspec 2&gt;&amp;1 | tail -50
</code></pre>

<p>âœ… <strong>CORRECT</strong> â€” Redirect to file:</p>
<pre class="code language-bash"><code class="language-bash">bundle exec rspec &gt; tmp/test_output.txt 2&gt;&amp;1
</code></pre>

<h2 id="ï¸-architecture">ğŸ—ï¸ Architecture</h2>

<h3 id="what-kettle-jem-provides">What kettle-jem Provides</h3>

<ul>
  <li>
<strong><code>Kettle::Jem::Presets</code></strong> â€” Pre-configured <code>MergerConfig</code> objects for each file type
    <ul>
      <li>
<code>Presets::Gemfile</code> â€” Gemfile merging (destination-wins, template-wins)</li>
      <li>
<code>Presets::Gemspec</code> â€” Gemspec merging</li>
      <li>
<code>Presets::Appraisals</code> â€” Appraisals file merging</li>
      <li>
<code>Presets::Markdown</code> â€” Markdown merging with fenced code block handling</li>
      <li>
<code>Presets::Rakefile</code> â€” Rakefile merging</li>
      <li>
<code>Presets::Yaml</code> â€” YAML file merging</li>
      <li>
<code>Presets::Json</code> â€” JSON file merging</li>
      <li>
<code>Presets::Rbs</code> â€” RBS (type signature) merging</li>
      <li>
<code>Presets::Dotenv</code> â€” Dotenv file merging</li>
    </ul>
  </li>
  <li>
<strong><code>Kettle::Jem::Classifiers</code></strong> â€” AST node classifiers for section typing
    <ul>
      <li>
<code>Classifiers::GemCall</code> â€” Classify <code>gem</code> method calls</li>
      <li>
<code>Classifiers::GemGroup</code> â€” Classify gem grouping blocks</li>
      <li>
<code>Classifiers::AppraisalBlock</code> â€” Classify Appraisal blocks</li>
      <li>
<code>Classifiers::MethodDef</code> â€” Classify method definitions</li>
      <li>
<code>Classifiers::SourceCall</code> â€” Classify <code>source</code> method calls</li>
    </ul>
  </li>
  <li>
<strong><code>Kettle::Jem::Signatures</code></strong> â€” Signature generators for structural matching</li>
  <li>
<strong><code>Kettle::Jem::RecipeLoader</code></strong> â€” YAML recipe loading and resolution</li>
  <li>
<strong>YAML Recipes</strong> â€” Declarative merge recipes for each file type (<code>recipes/*.yml</code>)</li>
</ul>

<h3 id="key-dependencies">Key Dependencies</h3>

<table>
  <thead>
    <tr>
      <th>Gem</th>
      <th>Role</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>
<code>ast-merge</code> (~&gt; 4.0)</td>
      <td>Shared merge infrastructure (SmartMergerBase, MergerConfig, etc.)</td>
    </tr>
    <tr>
      <td>
<code>tree_haver</code> (~&gt; 5.0)</td>
      <td>Unified AST parsing adapter</td>
    </tr>
    <tr>
      <td>
<code>prism-merge</code> (~&gt; 2.0)</td>
      <td>Ruby file merging (Gemfile, gemspec, Rakefile, Appraisals)</td>
    </tr>
    <tr>
      <td>
<code>markly-merge</code> (~&gt; 1.0)</td>
      <td>Markdown merging</td>
    </tr>
    <tr>
      <td>
<code>markdown-merge</code> (~&gt; 1.0)</td>
      <td>Generic markdown merging</td>
    </tr>
    <tr>
      <td>
<code>json-merge</code> (~&gt; 1.1)</td>
      <td>JSON file merging</td>
    </tr>
    <tr>
      <td>
<code>psych-merge</code> (~&gt; 1.0)</td>
      <td>YAML file merging</td>
    </tr>
    <tr>
      <td>
<code>rbs-merge</code> (~&gt; 2.0)</td>
      <td>RBS file merging</td>
    </tr>
    <tr>
      <td>
<code>bash-merge</code> (~&gt; 2.0)</td>
      <td>Bash file merging</td>
    </tr>
    <tr>
      <td>
<code>dotenv-merge</code> (~&gt; 1.0)</td>
      <td>Dotenv file merging</td>
    </tr>
    <tr>
      <td>
<code>version_gem</code> (~&gt; 1.1)</td>
      <td>Version management</td>
    </tr>
  </tbody>
</table>

<h3 id="vendor-directory">Vendor Directory</h3>

<p><strong>IMPORTANT</strong>: This project lives in <code>vendor/kettle-jem/</code> within the <code>ast-merge</code> workspace. It is a <strong>nested git project</strong> with its own <code>.git/</code> directory. The <code>grep_search</code> tool <strong>CANNOT search inside nested git projects</strong> â€” use <code>read_file</code> and <code>list_dir</code> instead.</p>

<h2 id="-project-structure">ğŸ“ Project Structure</h2>

<pre class="code ruby"><code class="ruby">lib/kettle/jem/
â”œâ”€â”€ classifiers/               # AST node classifiers
â”‚   â”œâ”€â”€ appraisal_block.rb     # Appraisal block classifier
â”‚   â”œâ”€â”€ gem_call.rb            # gem() call classifier
â”‚   â”œâ”€â”€ gem_group.rb           # Gem grouping classifier
â”‚   â”œâ”€â”€ method_def.rb          # Method definition classifier
â”‚   â””â”€â”€ source_call.rb         # source() call classifier
â”œâ”€â”€ classifiers.rb             # Classifier loader
â”œâ”€â”€ presets/                   # MergerConfig presets
â”‚   â”œâ”€â”€ appraisals.rb          # Appraisals file preset
â”‚   â”œâ”€â”€ base.rb                # Base preset class
â”‚   â”œâ”€â”€ dotenv.rb              # Dotenv preset
â”‚   â”œâ”€â”€ gemfile.rb             # Gemfile preset
â”‚   â”œâ”€â”€ gemspec.rb             # Gemspec preset
â”‚   â”œâ”€â”€ json.rb                # JSON preset
â”‚   â”œâ”€â”€ markdown.rb            # Markdown preset
â”‚   â”œâ”€â”€ rakefile.rb            # Rakefile preset
â”‚   â”œâ”€â”€ rbs.rb                 # RBS preset
â”‚   â””â”€â”€ yaml.rb                # YAML preset
â”œâ”€â”€ presets.rb                 # Preset loader
â”œâ”€â”€ recipe_loader.rb           # YAML recipe loader
â”œâ”€â”€ recipes/                   # YAML merge recipes
â”‚   â”œâ”€â”€ appraisals/            # Appraisals recipes
â”‚   â”‚   â””â”€â”€ signature_generator.rb
â”‚   â”œâ”€â”€ appraisals.yml
â”‚   â”œâ”€â”€ gemfile/               # Gemfile recipes
â”‚   â”‚   â”œâ”€â”€ signature_generator.rb
â”‚   â”‚   â””â”€â”€ typing/
â”‚   â”‚       â””â”€â”€ call_node.rb
â”‚   â”œâ”€â”€ gemfile.yml
â”‚   â”œâ”€â”€ gemspec/               # Gemspec recipes
â”‚   â”‚   â””â”€â”€ signature_generator.rb
â”‚   â”œâ”€â”€ gemspec.yml
â”‚   â”œâ”€â”€ markdown/              # Markdown recipes
â”‚   â”‚   â””â”€â”€ signature_generator.rb
â”‚   â”œâ”€â”€ markdown.yml
â”‚   â”œâ”€â”€ rakefile/              # Rakefile recipes
â”‚   â”‚   â””â”€â”€ signature_generator.rb
â”‚   â””â”€â”€ rakefile.yml
â”œâ”€â”€ signatures.rb              # Signature generator helpers
â””â”€â”€ version.rb                 # Version constant

spec/kettle/jem/
â”œâ”€â”€ classifiers/               # Classifier specs
â”œâ”€â”€ presets/                   # Preset specs
â”œâ”€â”€ signatures_spec.rb         # Signature specs
</code></pre>

<h2 id="-development-workflows">ğŸ”§ Development Workflows</h2>

<h3 id="running-tests">Running Tests</h3>

<pre class="code language-bash"><code class="language-bash">cd /home/pboling/src/kettle-rb/ast-merge/vendor/kettle-jem
</code></pre>
<pre class="code language-bash"><code class="language-bash">bundle exec rspec &gt; tmp/test_output.txt 2&gt;&amp;1
</code></pre>

<p>Single file (disable coverage threshold):</p>
<pre class="code language-bash"><code class="language-bash">K_SOUP_COV_MIN_HARD=false bundle exec rspec spec/kettle/jem/presets/gemfile_spec.rb &gt; tmp/test_output.txt 2&gt;&amp;1
</code></pre>

<h3 id="coverage-reports">Coverage Reports</h3>

<pre class="code language-bash"><code class="language-bash">cd /home/pboling/src/kettle-rb/ast-merge/vendor/kettle-jem
</code></pre>
<pre class="code language-bash"><code class="language-bash">bin/rake coverage &gt; tmp/coverage_output.txt 2&gt;&amp;1
</code></pre>

<h2 id="-project-conventions">ğŸ“ Project Conventions</h2>

<h3 id="preset-api-pattern">Preset API Pattern</h3>

<p>Each preset provides class methods that return <code>Ast::Merge::MergerConfig</code> objects:</p>

<pre class="code language-ruby"><code class="language-ruby"># Get a destination-wins config for Gemfile merging
config = Kettle::Jem::Presets::Gemfile.destination_wins
merger = Prism::Merge::SmartMerger.new(template, dest, **config.to_h)
result = merger.merge

# Get a template-wins config for Markdown merging
config = Kettle::Jem::Presets::Markdown.template_wins
merger = Markly::Merge::SmartMerger.new(template, dest, **config.to_h)
</code></pre>

<h3 id="yaml-recipe-format">YAML Recipe Format</h3>

<p>Recipes are YAML files that declare merge configuration:</p>

<pre class="code language-yaml"><code class="language-yaml"># recipes/gemfile.yml
signature_generator: &quot;Kettle::Jem::Recipes::Gemfile::SignatureGenerator&quot;
node_typing:
  call_node: &quot;Kettle::Jem::Recipes::Gemfile::Typing::CallNode&quot;
</code></pre>

<h3 id="forward-compatibility-with-options">Forward Compatibility with <code>**options</code>
</h3>

<p><strong>CRITICAL</strong>: All constructors and public API methods that accept keyword arguments MUST include <code>**options</code> as the final parameter.</p>

<h3 id="relationship-to-kettle-dev">Relationship to kettle-dev</h3>

<p><code>kettle-jem</code> extracts reusable merge presets and recipes that were previously embedded directly in <code>kettle-dev</code>â€™s templating code. <code>kettle-dev</code> depends on <code>kettle-jem</code> for its merge configurations when performing template updates.</p>

<h2 id="-testing-patterns">ğŸ§ª Testing Patterns</h2>

<h3 id="dependency-tags">Dependency Tags</h3>

<p>Use dependency tags from <code>ast-merge</code> to conditionally skip tests:</p>

<pre class="code language-ruby"><code class="language-ruby">RSpec.describe SomeClass, :prism_merge do
  # Skipped if prism-merge unavailable
end
</code></pre>

<h3 id="kettle-test-helpers">kettle-test Helpers</h3>

<p>All specs use <code>require "kettle/test/rspec"</code> for RSpec helpers (stubbed_env, block_is_expected, silent_stream, timecop).</p>

<h2 id="-critical-files">ğŸ” Critical Files</h2>

<table>
  <thead>
    <tr>
      <th>File</th>
      <th>Purpose</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>lib/kettle/jem/presets/gemfile.rb</code></td>
      <td>Gemfile merge preset</td>
    </tr>
    <tr>
      <td><code>lib/kettle/jem/presets/base.rb</code></td>
      <td>Base preset class</td>
    </tr>
    <tr>
      <td><code>lib/kettle/jem/classifiers/gem_call.rb</code></td>
      <td>gem() call classifier</td>
    </tr>
    <tr>
      <td><code>lib/kettle/jem/recipe_loader.rb</code></td>
      <td>YAML recipe loading</td>
    </tr>
    <tr>
      <td><code>lib/kettle/jem/signatures.rb</code></td>
      <td>Signature generators</td>
    </tr>
    <tr>
      <td><code>lib/kettle/jem/recipes/gemfile.yml</code></td>
      <td>Gemfile merge recipe</td>
    </tr>
  </tbody>
</table>

<h2 id="-common-pitfalls">ğŸš« Common Pitfalls</h2>

<ol>
  <li>
<strong>NEVER add backward compatibility</strong> â€” No shims, aliases, or deprecation layers.</li>
  <li>
<strong>NEVER chain <code>cd</code> with <code>&amp;&amp;</code></strong> â€” <code>direnv</code> wonâ€™t initialize until after all chained commands finish.</li>
  <li>
<strong>NEVER pipe test output through <code>head</code>/<code>tail</code></strong> â€” Redirect to <code>tmp/</code> files instead.</li>
  <li>
<strong>Terminal output is invisible</strong> â€” Always redirect to <code>tmp/</code> and read back with <code>read_file</code>.</li>
  <li>
<strong><code>grep_search</code> cannot search nested git projects</strong> â€” Use <code>read_file</code> and <code>list_dir</code> to explore this codebase.</li>
  <li>
<strong>Use <code>tmp/</code> for temporary files</strong> â€” Never use <code>/tmp</code> or other system directories.</li>
  <li>
<strong>Presets return <code>MergerConfig</code> objects</strong> â€” Use <code>.to_h</code> to pass options to SmartMerger constructors.</li>
</ol>
</div></div>

      <div id="footer">
  Generated on Fri Feb 20 07:28:56 2026 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.38 (ruby-4.0.1).
</div>

    </div>
  </body>
</html>